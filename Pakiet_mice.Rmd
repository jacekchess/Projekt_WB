---
title: "Pakiet mice"
author: "Martyna Majchrzak, Agata Makarewicz, Jacek Wiśniewski"
date: "26 03 2020"
header-includes:
- \titlegraphic{\centering \includegraphics[width=5cm]{mouse_emoji.png}}
output: beamer_presentation

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(mice)
library(knitr)
```

## Wprowadzenie

MICE - Multivariate Imputation by Chained Equations
(wielowymiarowa imputacja za pomocą równań łańcuchowych)

## Wykorzystanie

Pakiet mice zawiera funkcje służące do:

- generowania symulowanych niekompletnych danych (-> ampute)
- sprawdzenia wzorca brakujących danych (-> md.pattern, ...)
- imputacji brakujących danych (wielokrotnie) (-> mice)
- diagnozowania jakości imputowanych wartości (jakie funkcje?) 
- analizy każdego uzupełnionego zbioru danych (?)
- zebrania wyników powtarzanych analiz (-> pool)
- przechowywania i eksportowania imputowanych danych w różnych formatach (?)
- (Incorporate custom imputation methods)?



## Zbiory danych dostępne w pakiecie mice

- boys (wzrost, waga, wiek ... duńskich chłopców)
- brandsma (dane o uczniach z różnych szkół)
- pattern1,2,3,4 (proste zbiory danych z różnymi wzorcami braków danych)


## Generowanie braków danych

-  funkcja `ampute`
- generowanie brakujących danych potrzebnych do symulacji
  - określony procent danych zostaje zastąpiony NA 
    (obserwacje są wybierane losowo)
  - różne mechanizmy: MAR (Missing At Random), 
                      MCAR (Missing Completely At Random), 
                      MNAR (Missing Not At Random)
  - określenie wzorca braków danych oraz częstotliwości 
    jego wystąpienia


---

```{r} 
set.seed(1)
```
```{r ampute, echo=TRUE,results=FALSE}
iris_amp <- ampute(iris[,-5], prop = 0.5, mech = "MCAR")


```

## Sprawdzenie wzorca brakujących danych

Więkoszość metod do rysowania wykresów nadpisuje funkcje z pakietu `lattice`.

- `bwplot` 
- `md.pattern`
- wyświetlenie wzorca brakujących danych w formie wykresu (oraz tabeli - w konsoli)
- `fluxplot` <- # done

---

```{r bwplot, echo=TRUE,results=FALSE}
mice::bwplot(iris_amp, which.pat = 1)
```
---  

```{r, echo= TRUE,  fig.height=4, fig.width=6, results='hide', fig.keep='all'}
md.pattern(iris_amp$amp, plot = TRUE, rotate.names = TRUE)
```

---

```{r, echo=TRUE, fig.height=3, fig.width=6,out.width='80%', fig.align='center',fig.show='hide'}
md.pattern(iris_amp$amp, plot = TRUE, rotate.names = TRUE)
```

---

### Fluxplot
Dla każdej zmiennej obliczane są 2 wartości:

 - Influx - liczba par zmiennych takich, że w danej jest brak a w drugiej nie, podzielona przez wszystkie obserwacje. Dane pełne: 0, Dane całkowicie brakujące:1

 - Outflux - liczba par zmiennych takich, że w danej jest obserwacja a w drugiej brak, podzielona przez wszystkie obserwacje. Dane pełne: 1, Dane całkowicie brakujące:0. Potencjalna użytecznośc do imputowania innych zmiennych.

```{r fluxplot} 
fluxplot(iris_amp$amp)
```

## Inne metody wizualizacji danych imputowanych

- xyplot 
- densityplot 
- stripplot

# Imputacja danych

## Zbiór danych boys


```{r info, fig.height=3,fig.width=6}
# zajmujemy sie boys bo maja ordered/unordered factor -  nie mają binarnej kolumny - to nw, najwyżej inny zbiór danych?
str(boys)
```
---
Zbiór zawiera już braki danych, ma kolumny:
 - numeryczne
 - kategoryczne uporządkowane
 - kategoryczne nieuporządkowane


## Funkcja mice 

W zależności od typu brakujących danych, funkcja mice przyjmuje jako parametr inne metody imputacji danych.\
Dane podzielone są na 4 kategorie:

- dane numeryczne (ciągłe)
- dane binarne (dane typu factor z dwoma poziomami)
- nieuporządkowane dane kategoryczne (dane typu factor z więcej niż 2 poziomami)
- uporządkowane dane kategoryczne (dane typu factor z więcej niż 2 poziomami uporządkowanymi)

## Dowolne dane

Niektóre metody imputacji możemy zastosować do każdego typu danych.

- pmm (predictive mean matching/predykcyjne dopasowanie średniej)
- midastouch (weighted predictive mean matching/ ?)
- sample (losowa próbka)
- cart (drzewo klasyfikacyjne i regresji (?))
- rf (random forest/lasy losowe)
- 2lonly.pmm (Level-2 class predictive mean matching) <- ?

## Dane numeryczne 

- pmm (domyślna)
- mean (średnia)
- norm (Bayesian linear regression/regresja liniowa)
  - norm.nob (linear regression ignoring model error)
  - norm.boot (linear regression using bootstrap)
  - norm.predict (linear regression, predicted values)
- quadratic (imputation of quadratic terms)
- ri (random indicator for nonignorable data)

---

```{r num}
dutch_boys<-boys
imp <- mice(dutch_boys[,-c(6,7,9)],
            method="pmm", m=3, maxit=3)
dutch_boys[,-c(6,7,9)] <- complete(imp)
```

---
## Metody wizualizacji danych imputowanych

- densityplot 
- stripplot
- xyplot 


```{r densityplot}
## co on właściwie rysuje?
## argumenty na.groups i groups
densityplot(imp)
```

---

```{r}
stripplot(imp,col=c("grey",mdc(2)),pch=c(1,20))
```


## Nieuporządkowane dane kategoryczne

- polyreg (Polytomous logistic regression) (domyślna)
- lda (liniowa analiza dyskryminacyjna)

---

```{r lda}
imp <- mice(dutch_boys[,-9], method="lda", m=3, maxit=3)
dutch_boys[,-9] <- complete(imp)
```

---

```{r}
xyplot(imp, gen+phb ~ hgt+wgt,
       cex=1,col=c("grey",mdc(2)),pch=c(1,20))
```

## Uporządkowane dane kategoryczne

- polr (Proportional odds model) (domyślna)

---

```{r polr}
imp <- mice(dutch_boys, method="polr", m=3, maxit=3)
dutch_boys <- complete(imp)
```

---

```{r}
xyplot(imp,reg ~ hgt+wgt,
       cex=3,col=c("grey",mdc(2)),pch=20)
```

## Dane binarne

- logreg (logistic regression/regresja logistyczna) (domyślna)
- logreg.boot  (logistic regression with bootstrap)

---

```{r mtcars}
# Ponieważ w zbiorze danych boys nie ma danych binarnych, posłużymy się zbiorem mtcars
# usuwamy tylko w tych dwóch kolumach: vs i am
mtcars_amp<-ampute(data=mtcars,
                   patterns=rbind(
                     c(1,1,1,1,1,1,1,0,1,1,1),
                     c(1,1,1,1,1,1,1,1,0,1,1)),
                   prop = 0.5,
                   mech="MCAR")$amp
str(mtcars_amp)
```

---
```{r}
imp <- mice(mtcars_amp[,c(8,9)], method="logreg")
mtcars_amp[,c(8,9)] <- complete(imp)
str(mtcars_amp)
```

## Zebranie wyników analiz

- Funkcja pool

---
```{r pool, results='hide'}
temp <- mice(dutch_boys, m = 20, maxit = 5, seed = 123)
modelFit <- with(temp, lm(age ~ hgt + wgt))
```
```{r}
knitr::kable(summary(pool(modelFit)), align = "c")
```